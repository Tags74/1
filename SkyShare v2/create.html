<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkyShare - Host</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="audio.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f7ff; color: #1a3a5f; text-align: center; margin: 0; padding: 20px; }
        .container { max-width: 500px; margin: 20px auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        h1 { margin-top: 0; color: #2196f3; font-size: 1.8rem; }
        #codeBox { font-size: 2.2rem; font-weight: bold; color: #1565c0; background: #e3f2fd; padding: 15px; border-radius: 12px; margin: 15px 0; border: 2px dashed #2196f3; display: none; }
        .btn { background: #2196f3; color: white; padding: 16px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 1.1rem; width: 100%; margin-bottom: 10px; }
        .btn-danger { background: #f44336; display: none; }
        #preview { width: 100%; border-radius: 10px; background: #000; display: none; margin-top: 15px; }
        .meter-container { width: 100%; height: 10px; background: #eee; border-radius: 5px; margin: 10px 0; display: none; overflow: hidden; }
        #audioMeter { height: 100%; width: 0%; background: #4caf50; transition: width 0.1s; }
        #status { color: #666; font-size: 0.8rem; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>SkyShare Host</h1>
        <p id="status">Connecting...</p>
        <div id="codeBox">------</div>
        <div class="meter-container" id="meterBox"><div id="audioMeter"></div></div>
        <button id="startBtn" class="btn" disabled>START MIRRORING</button>
        <button id="stopBtn" class="btn btn-danger">END STREAM</button>
        <video id="preview" autoplay playsinline muted></video>
    </div>

    <script>
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const codeBox = document.getElementById('codeBox');
        const preview = document.getElementById('preview');
        const meter = document.getElementById('audioMeter');
        const meterBox = document.getElementById('meterBox');
        let localStream = null;
        
        const secretCode = Math.random().toString(36).substring(2, 8).toUpperCase();
        const peer = new Peer(secretCode);

        peer.on('open', (id) => {
            document.getElementById('status').innerText = "Ready to Share";
            codeBox.innerText = id;
            codeBox.style.display = 'block';
            startBtn.disabled = false;
        });

        // FIXED: The listener is now always active but waits for the stream
        peer.on('call', (call) => {
            if (localStream) {
                console.log("Answering with tracks:", localStream.getTracks().length);
                call.answer(localStream);
            } else {
                alert("Viewer trying to connect, but you haven't started sharing yet!");
            }
        });

        startBtn.onclick = async () => {
            if (AudioModule.isMobile()) {
                window.location.href = "mobile-instructions.html";
                return;
            }

            localStream = await AudioModule.getDesktopStream();
            
            if (localStream) {
                preview.srcObject = localStream;
                preview.style.display = "block";
                startBtn.style.display = 'none';
                stopBtn.style.display = 'block';
                document.getElementById('status').innerText = "LIVE";

                if (localStream.getAudioTracks().length > 0) {
                    meterBox.style.display = "block";
                    setupVisualizer(localStream);
                } else {
                    alert("CRITICAL: No audio track detected. Make sure you select a 'CHROME TAB' and check 'SHARE TAB AUDIO'.");
                }
            }
        };

        function setupVisualizer(stream) {
            const audioCtx = new AudioContext();
            const source = audioCtx.createMediaStreamSource(stream);
            const analyzer = audioCtx.createAnalyser();
            source.connect(analyzer);
            const data = new Uint8Array(analyzer.frequencyBinCount);
            function update() {
                analyzer.getByteFrequencyData(data);
                const volume = Math.max(...data) / 255 * 100;
                meter.style.width = volume + "%";
                requestAnimationFrame(update);
            }
            update();
        }

        stopBtn.onclick = () => location.reload();
    </script>
</body>
</html>